(function(c){c.widget("ra.timeline",{options:{date:new Date,monthChanged:function(){},months:"January,February,March,April,May,June,July,August,September,October,November,December".split(","),range:4,url:null},_create:function(){this.options.url||alert("Timeline widget needs to be initialized with url option");this._build();this._bindEvents();this.refresh()},_build:function(){this.element.addClass("ra-timeline");this.next=c('<a class="range next" href="javascript:void();">Next</a>').appendTo(this.element); this.previous=c('<a class="range previous" href="javascript:void();">Previous</a>').appendTo(this.element);this.months=c("<ul></ul>").appendTo(this.element);this.handle=c('<div class="handle"></div>').appendTo(this.element);this.handleOffset=parseInt(this.element.css("padding-left"),10);this._moveHandleToRight()},_bindEvents:function(){var b=0,a=this;c(window).resize(function(){a.redraw()});this.handle.draggable({axis:"x",containment:this.element,drag:function(f,g){var d=Math.floor((g.position.left- a.handleOffset)/a.monthWidth);if(d!==b){b=d;var e=c(a.months.children().get(d)),d=e.attr("data-month"),e=e.attr("data-year");a.options.monthChanged(d,e)}}});this.previous.bind("click.timeline",function(b){b.preventDefault();a.options.date.setMonth(a.options.date.getMonth()-a.options.range);a._moveHandleToRight();a.options.monthChanged(a.options.date.getMonth()+1,a.options.date.getFullYear());a.refresh()});this.next.bind("click.timeline",function(b){b.preventDefault();b=a._getNextMonthDate();a.options.monthChanged(b.getMonth()+ 1,b.getFullYear());a.options.date.setMonth(a.options.date.getMonth()+a.options.range);a._moveHandleToLeft();a.refresh()})},_getCurrentDate:function(){return new Date(this.options.date.getFullYear(),this.options.date.getMonth(),1)},_getNextMonthDate:function(){var b=this._getCurrentDate();b.setMonth(this.options.date.getMonth()+1);return b},_getPreviousMonthDate:function(){var b=this._getCurrentDate();b.setMonth(this.options.date.getMonth()-1);return b},_moveHandleToLeft:function(){this.handle.css("left", this.handleOffset)},_moveHandleToRight:function(){this.handle.css("left",this.months.width()-this.handle.width()+this.handleOffset)},redraw:function(){this.months.find("li").remove();var b=this.options.range,a=this._getCurrentDate();for(this.monthWidth=Math.floor(this.months.width()/this.options.range)-1;b--;)this.months.prepend('<li style="width:'+this.monthWidth+'px" data-year="'+a.getFullYear()+'" data-month="'+(parseInt(a.getMonth(),10)+1)+'"><span class="month">'+this.getMonthName(a)+'</span><span class="bar"><span></span></span></li>'), a.setMonth(a.getMonth()-1);this._moveHandleToRight()},refresh:function(){this.redraw();var b=this,a=this._getCurrentDate();c.ajax({url:this.options.url,data:{from:{month:a.getMonth()+1-this.options.range,year:a.getFullYear()},to:{month:this.options.date.getMonth()+1,year:this.options.date.getFullYear()}},beforeSend:function(a){a.setRequestHeader("Accept","application/json")},success:function(a){var g=b.months.find(".bar").first().height(),d=0,e=function(a){return b.months.find("li[data-year="+a.year+ "][data-month="+a.month+"] .bar span").first()};c(a).each(function(a,b){if(e(b.history).length&&b.history.record_count>d)d=b.history.record_count});c(a).each(function(a,c){var f="",i=e(c.history),j=0,h=0;i.length&&(c.history.record_count>0&&(h=parseFloat(c.history.record_count/d),f=b.getBarClass(h),j=Math.floor(g*h)),i.toggleClass(f,300).animate({height:j},1E3,"easeOutBounce"))})},error:function(a){dialog.html(a.responseText)}})},getBarClass:function(b){return b<0.33?"low":b<0.67?"medium":"high"}, getMonthName:function(b){return this.options.months[b.getMonth()]}})})(jQuery);