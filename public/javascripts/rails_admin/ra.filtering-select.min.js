(function(b){b.widget("ra.filteringSelect",{options:{createQuery:function(b){return{query:b}},minLength:0,searchDelay:200,source:null},_create:function(){var f=this,e=this.element.hide(),d=e.children(":selected"),d=d.val()?d.text():"";if(!this.options.source)this.options.source=e.children("option").map(function(){return{label:b(this).text(),value:this.value}}).toArray();var a=this.input=b("<input>").insertAfter(e).val(d).addClass("ra-filtering-select-input").attr("style",e.attr("style")).show().autocomplete({delay:this.options.searchDelay, minLength:this.options.minLength,source:this._getSourceFunction(this.options.source),select:function(c,a){var d=b('<option value="'+a.item.id+'" selected="selected">'+a.item.value+"</option>");e.html(d);f._trigger("selected",c,{item:d})},change:function(c,d){if(!d.item){var f=RegExp("^"+b.ui.autocomplete.escapeRegex(b(this).val())+"$","i"),g=false;e.children("option").each(function(){if(b(this).text().match(f))return this.selected=g=true,false});if(!g)return b(this).val(""),e.val(""),a.data("autocomplete").term= "",false}}}).addClass("ui-widget ui-widget-content ui-corner-left");a.data("autocomplete")._renderItem=function(c,a){return b("<li></li>").data("item.autocomplete",a).append("<a>"+a.label||a.id+"</a>").appendTo(c)};this.button=b("<button type='button'>&nbsp;</button>").attr("tabIndex",-1).attr("title","Show All Items").insertAfter(a).button({icons:{primary:"ui-icon-triangle-1-s"},text:false}).removeClass("ui-corner-all").addClass("ra-filtering-select-button ui-corner-right").click(function(){a.autocomplete("widget").is(":visible")? a.autocomplete("close"):(a.autocomplete("search",""),a.focus())})},_getResultSet:function(f,e,d){var a=RegExp(b.ui.autocomplete.escapeRegex(f.term),"i");return b.map(e,function(c){if((c.id||c.value)&&(d||a.test(c.label)))return{label:c.label?c.label.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.ui.autocomplete.escapeRegex(f.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"):c.id,value:c.label||c.id,id:c.id||c.value}})},_getSourceFunction:function(f){var e=this,d=0;return b.isArray(f)?function(a, c){c(e._getResultSet(a,f,false))}:typeof f==="string"?function(a,c){this.xhr&&this.xhr.abort();this.xhr=b.ajax({url:f,data:e.options.createQuery(a.term),dataType:"json",autocompleteRequest:++d,success:function(b){this.autocompleteRequest===d&&c(e._getResultSet(a,b,true))},error:function(){this.autocompleteRequest===d&&c([])}})}:f},destroy:function(){this.input.remove();this.button.remove();this.element.show();b.Widget.prototype.destroy.call(this)}})})(jQuery);