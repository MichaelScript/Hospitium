(function(b){b.widget("ra.filteringMultiselect",{_cache:{},options:{createQuery:function(a){return{query:a}},sortable:false,regional:{up:"Up",down:"Down",add:"Add",chooseAll:"Choose all",chosen:"Chosen records",clearAll:"Clear all",remove:"Remove",selectChoice:"Select your choice(s) and click"},searchDelay:400,source:null},_create:function(){this._cache={};this._build();this._buildCache();this._bindEvents()},_build:function(){var a;this.wrapper=b('<div class="input ra-multiselect">');this.wrapper.insertAfter(this.element); this.header=b('<div class="ra-multiselect-header ui-helper-clearfix">');this.filter=b('<input type="text" class="ra-multiselect-search"/>');this.header.append(this.filter).append('<div class="help"><strong>'+this.options.regional.chosen+"</strong><br />"+this.options.regional.selectChoice+'</div><div class="ui-icon ui-icon-circle-triangle-e"></div>');this.wrapper.append(this.header);this.columns={left:b('<div class="ra-multiselect-column ra-multiselect-left">'),center:b('<div class="ra-multiselect-column ra-multiselect-center">'), right:b('<div class="ra-multiselect-column ra-multiselect-right">')};for(a in this.columns)this.columns.hasOwnProperty(a)&&this.wrapper.append(this.columns[a]);this.collection=b('<select multiple="multiple"></select>');this.collection.addClass("ra-multiselect-collection");this.addAll=b('<a class="ra-multiselect-item-add-all"><span class="ui-icon ui-icon-circle-triangle-e"></span>'+this.options.regional.chooseAll+"</a>");this.columns.left.append(this.collection).append(this.addAll);this.add=b('<a class="ui-icon ui-icon-circle-triangle-e ra-multiselect-item-add">'+ this.options.regional.add+"</a>");this.remove=b('<a class="ui-icon ui-icon-circle-triangle-w ra-multiselect-item-remove">'+this.options.regional.remove+"</a>");this.columns.center.append(this.add).append(this.remove);if(this.options.sortable)this.up=b('<a class="ui-icon ui-icon-circle-triangle-n ra-multiselect-item-up">'+this.options.regional.up+"</a>"),this.down=b('<a class="ui-icon ui-icon-circle-triangle-s ra-multiselect-item-down">'+this.options.regional.down+"</a>"),this.columns.center.append(this.up).append(this.down); this.selection=b('<select class="ra-multiselect-selection" multiple="multiple"></select>');this.removeAll=b('<a class="ra-multiselect-item-remove-all"><span class="ui-icon ui-icon-circle-triangle-w"></span>'+this.options.regional.clearAll+"</a>");this.columns.right.append(this.selection).append(this.removeAll);this.element.css({display:"none"})},_bindEvents:function(){var a=this;this.addAll.click(function(){a._select(b("option",a.collection))});this.add.click(function(){a._select(b(":selected",a.collection))}); this.removeAll.click(function(){a._deSelect(b("option",a.selection))});this.remove.click(function(){a._deSelect(b(":selected",a.selection))});var c=null;this.options.sortable&&(this.up.click(function(){a._move("up",b(":selected",a.selection))}),this.down.click(function(){a._move("down",b(":selected",a.selection))}));this.filter.keyup(function(){c&&clearTimeout(c);c=setTimeout(function(){a._query(a.filter.val(),function(b){var e,c="";for(e in b)b.hasOwnProperty(e)&&!a.selected(b[e].id)&&(c+='<option value="'+ b[e].id+'">'+b[e].label+"</option>");a.collection.html(c)})},a.options.searchDelay)})},_buildCache:function(){var a=this;this.element.find("option").each(function(c,d){d.selected?(a._cache[d.value]=d.innerHTML,b(d).clone().appendTo(a.selection).attr("selected",false)):(a._cache[d.value]=d.innerHTML,b(d).clone().appendTo(a.collection).attr("selected",false))})},_deSelect:function(a){var c=this;a.each(function(a,b){c.element.find("option[value="+b.value+"]").removeAttr("selected")});b(a).appendTo(this.collection).attr("selected", false)},_query:function(a,c){var d,e=[];if(a===""){if(!this.options.source)for(d in this._cache)this._cache.hasOwnProperty(d)&&e.push({id:d,label:this._cache[d]});c.apply(this,[e])}else if(this.options.source)b.ajax({beforeSend:function(a){a.setRequestHeader("Accept","application/json")},url:this.options.source,data:this.options.createQuery(a),success:c});else{a=RegExp(a+".*","i");for(d in this._cache)this._cache.hasOwnProperty(d)&&a.test(this._cache[d])&&e.push({id:d,label:this._cache[d]});c.apply(this, [e])}},_select:function(a){var c=this;a.each(function(a,e){var h=c.element.find("option[value="+e.value+"]");h.length?h.attr("selected","selected"):c.element.append(b('<option value="'+e.value+'" selected="selected"></option>'))});b(a).appendTo(this.selection).attr("selected",false)},_move:function(a,c){var d=this;a=="up"?c.each(function(a,c){var f=b(c).prev();if(f.length>0){var g=d.element.find("option[value="+c.value+"]");d.element.find("option[value="+f[0].value+"]").before(g);f.before(b(c))}}): (b.fn.reverse=[].reverse,c.reverse().each(function(a,c){var f=b(c).next();if(f.length>0){var g=d.element.find("option[value="+c.value+"]");d.element.find("option[value="+f[0].value+"]").after(g);f.after(b(c))}}))},selected:function(a){return this.element.find("option[value="+a+"]").attr("selected")},destroy:function(){this.wrapper.remove();this.element.css({display:"inline"});b.Widget.prototype.destroy.apply(this,arguments)}})})(jQuery);